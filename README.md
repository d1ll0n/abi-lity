# abi-lity

Solidity codegen and inspection tool for efficient ABI encoding/decoding.

Currently supports decoding calldata. Returndata decoding and ABI encoding are target features.

**Note:** Overflow protection is implemented by masking the last 4 bytes of any component which is used to derive a calldata pointer or length, provided that that value still yields valid ABI encoding. This may result in inconsistent behavior between abi-lity and solc's decoders. It may not revert when given an offset or length which would cause a pointer to overflow, whereas solc would throw in that case.

## Command Groups

- Test
- Codegen
- [Inspection](#)

## TODO

- [ ] Generate interface for contract
  - In contract and all base contracts, get all external/public functions, public state variables, event/error/struct definitions, as well as all error/struct definitions used as return types and all events and errors which are referenced in an emit/revert statement.
- [x] Determine when abi encoding is redundant (type has same layout in sol and memory) and skip encoding.
  - Partially finished - works for dynamic value arrays and bytes in creation of return functions.
- [ ] Generate event emitter helpers.
  - [ ] Auto replace all `emit Event`
- [ ] Generate external function call helpers.
  - [ ] Auto replace all `contract.<method>(...)`
- [x] Generate hash functions.
  - [x] Automatically replace `keccak256(abi.encode(...))` expressions (in step prior to replacing other `abi.encode` calls)
- [x] Automatically replace all `abi.encode` calls.
- [ ] Automatically replace all `abi.decode` calls.
- [ ] More analysis of various array loop patterns in yul IR.
- [ ] Handle functions overriding interface functions
  - 1. Get full set of interfaces a contract inherits.
  - 2. For each interface, if it has any non-function definitions, copy the interface with only those.
  - 3. Collect the set of function signatures from the interface.
  - 4. Go over every contract which inherits the interface.
    - If the interface was replaced, replace the base contract reference in the contract's `inheritanceSpecifiers` & `linearizedBaseContracts`.
    - Find all functions in the contract which have the same signature as one of the removed functions
    - and which have an override specifier.
      - If `vOverrideSpecifier.vOverrides` is empty, remove `vOverrideSpecifier`.
      - If `vOverrideSpecifier.vOverrides` has >1 member, remove the override which points to the interface function.
      - If `vOverrideSpecifier.vOverrides` has 1 member after the last step, delete `vOverrideSpecifier.vOverrides` but leave `vOverrideSpecifier`.
- [ ] Compare specific array decoders/encoders with array helpers (map/reduce)

**Generics**
Determine whether certain abstractions can be made with zero cost.

```ts
// copyDynamicArrayDynamicBase(src, dst, encodeElementFunction) -> size
uint256 length = srcLength.readUint256();
dstLength.write(length);
MemoryPointer srcHead = srcLength.next();
MemoryPointer dstHead = dstLength.next();
uint256 headOffset;
uint256 headSize = length << OneWordShift;
size = headSize;
while (headOffset < headSize) {
  /// Write tail offset to the array head.
  dstHead.offset(headOffset).write(size);
  /// Encode the item into the array tail and add its encoded size to the total
  size += encodeElementFunction(srcHead.pptr(headOffset), dstHead.offset(size));
  headOffset += OneWord;
}
size += 32;
```

# Usage

## View optimized yul for a contract or function.

The `ir` command allows you to inspect the optimized yul generated by solc. See: [ir usage](#ir)

```sh
$ git clone git@github.com:transmissions11/solmate && cd solmate
$ abi-lity src/test/utils/mocks/MockERC20.sol --inspect transfer

Found yul function transfer in MockERC20:
./src/MockERC20.optimized.yul:212:4
```

Following that link takes us to the code for the `transfer` function in MockERC20.sol:

![](https://i.imgur.com/WELaKIg.png)

## Generate ABI decoding libraries

## Build

```
yarn && yarn build
chmod +x ./dist/cli.js
sudo npm link
```

# Codegen

## `eq`

**Usage**

```bash
abi-lity eq <input> [output]
```

**Options**

```bash
-i, --input    Input Solidity file.                                 [required]
-o, --output   Output directory, defaults to directory of input.    [required]
-s, --struct   Struct(s) to generate assertions for.                   [array]
                                             example: --struct Struct1 Struct2
```

## `json`

## `pointers`

## `coders`

Currently supports:

- generating ABI decoding libraries for arbitrary types
- modify all external functions in a contract to use generated

# Inspection

## `ir`

Compiles a contract and outputs the IR (yul) generated by solc. By default, only writes irOptimized and strips out all sourcemap comments and the constructor.

Using `--unoptimized` will output both the optimized and unoptimized IR.

Using `--verbose` will output the entire generated IR, including the constructor and sourcemap comments.

Optionally inspect specific functions.

**Usage**

```bash
abi-lity ir <input> [output]
```

**Options**

```sh
-i, --input        Input Solidity file.                             [required]
-o, --output       Output directory, defaults to directory of input.
-u, --unoptimized  Only generate unoptimized IR.    [boolean] [default: false]
-v, --verbose      Keep the constructor and sourcemap comments.
                                                    [boolean] [default: false]
-s, --inspect      Inspect the generated IR for a specific function.   [array]
```

**Example**

```bash
abi-lity ir ./src/ERC20.sol --inspect transfer approve
```

## `selectors`

## `size`

# Test

## `compare`

## `copy-test`

## `wrappers`

# Decoder codegen

To generate decoders for a contract and automatically modify all external functions to use the decoders and a function switch, run:

```
abi-lity ./input-sol-file ./output-dir
```

**Flags**

`-d, --decoderOnly` only generate decoding files, do not modify the contract

`-y, --ir ` output `irOptimized` for the contract

`-u, --irUnoptimized` output `ir` (unoptimized) for the contract in addition to the optimized IR

`-v, --verbose` By default, all comments in the IR output will be removed. Setting this flag will keep them in.

## IR codegen

To generate `irOptimized` for a contract:

```
abi-lity ir ./input-sol-file ./output-dir
```

**Flags**

`-u, --unoptimized` output `ir` (unoptimized) for the contract in addition to the optimized IR

`-v, --verbose` By default, all comments in the IR output will be removed. Setting this flag will keep them in.

## Known Bugs

Currently only applies function edits to contract in root file, not any inherited contracts. This also means any overridden functions in the root file will break. Overrides will be removed if the function is modified, but the inherited contract will not be edited or removed.

Currently breaks if more than one contract is defined in root file.
